sudo: required

services:
  - docker

env:
  global:
    - REGISTRY_USER=kalemena
    - secure: "y90E8XDiW5xlCXuuq5ATwosJ2pX1t0mI9nMIkg4vJoowQbroE7fUrvlAgqNd3IW5xBRwexfAgUPgSF61L5mwhnAyoZpkMVI1KPu2MqmWnDuVjQcfS6l0NCcpkQkSfqeRm3gjLFmJ37CApqCNFLthDBhz3H9Zf6TNzAeYK64JQPqJyxtIu/MoCePKhc9S6IJ1LWHqIMczFF+BZmiMn72KNaKk4Hv4vRlLgk2dN0ePsLGIlLVSqvcW4Yesb+SBZDeUmeTWJW8rUuTPG2R/jvhjyHkiNBYQ1mPm/HAfh7xzF18bcDf5yHTjgnThLeFQnI+tgXi1uMQeUD8Fi+Hwsyxy79sH//3yxf7i56HLeU+RqHulOjyOpsUdwr86QG8Um6oOft1U2d+WIM6dzjaeVoO5/wRsqpTO77cepg7nZckXoBlPPNuiUFfZgJLXJGbO6fRFk4y8MiGtZtCsvuc1QftqE/yXC1qUQSG3vfzNuobSL2s02UwSmuUmH3jVfFHZ8s/KEahRz6Wac4KKz5HWrsYxhzg6+tl9Xp5ZFIV93LfRrC2qhMrNLxOsAvhbPqzcatWUKB3x97tTMHMnzRvU1p6/flKe1gzyYRPuMJ4HdxQPgFj7bpGN3PC27WbgMRIVr1XWsTgRHTFY8rCL9C7RwGYF2mWzS0o09Vte3Ho7XC4oGGM="
  matrix:
    - IMAGE="kalemena/zeroconf" VERSION="1.0" REPO="kalemena/docker-zeroconf"

before_script:
  - docker pull centos:7
  - docker pull ${IMAGE}:${VERSION} || true

script:
  - |
    docker build --pull --cache-from ${IMAGE}:${VERSION} \
      -t ${IMAGE}:${VERSION} \
      -f Dockerfile \
      --build-arg BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"` \
      --build-arg VCS_REF=`git rev-parse --short HEAD` \
      --build-arg VERSION=`cat VERSION` .
  - docker ps -a
  - docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest
  - docker images

before_deploy:
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"

deploy:
  provider: script
  script: docker push ${IMAGE}:${VERSION}; docker push ${IMAGE}:latest
  on:
    branch: master
