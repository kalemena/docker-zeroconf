sudo: required
services:
- docker
env:
  global:
  - REGISTRY_USER=kalemena
  - secure: oSQMcCCQydlYz+hIW271NI3BQ2vhMoL130980ZSEwox391PnnJrh673cNPm5GOU+61tCqDDq4TC1veR2FxROOBxbAwXa9RSJmHdY+KoF+duDTIFD4BEdQpOhMjL++kmChzBv2hMVYc33ZNk4s0gvyUpj5/4o3DKv0rKBSUBKePbJneLM698PzKuXKXsAKRnBea59VZhcvYYIDoDSIIn5T7MhvS2WhyEIq6ctw+zHoDWm+yHwzFElXLtTaxH3Ru8Ms5dJAZPxVQ/lt7Tp9Jo0aT12My9NYi8xqQHUFWpYIEQDeKQsdTvJTGuyiaJz7ENurTVy3wdGMuFDReypWHiSTaJGaQjJxoKVY3aQDQmxGoNYnOoNuqpbwu3iCVhoYfCJlUe2JBIXIEKMMGS2+l5Q4sIVS5D5J3LBEWY7Ktkh8sUxkGtCEwjrz9M/09NRX+JJ6R8Du01opigcWGqYzbLeJcytvBOobBUISJ2Tm80QVhphD+ag/AMq+xpWkQJ4F30HglFghN6b3rZDGlwmp/Pkv7P/QrjkhBXICRPIRUEGHJ9XF6OzgSVC80DG5nJh9rWrdOGAqqKJtFxUkBFnGAmE6E+4bH5cYCRvUp/26hOFe1Yppd08yqC37OsEbU8z/PFHTbKK+CSh8fkmG5jThBTg7pUb76MgSt1XG9XdXA/p1l8=
  matrix:
  - IMAGE="kalemena/zeroconf" VERSION="0.24.4" REPO="kalemena/docker-zeroconf"
before_script:
- docker pull python:3
- docker pull ${IMAGE}:${VERSION} || true
script:
- |
  docker build --pull --cache-from ${IMAGE}:${VERSION} \
    -t ${IMAGE}:${VERSION} \
    -f Dockerfile \
    --build-arg BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"` \
    --build-arg VCS_REF=`git rev-parse --short HEAD` \
    --build-arg VERSION=`cat VERSION` .
- docker ps -a
- docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest
- docker images
before_deploy:
- docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
  provider: script
  script: docker push ${IMAGE}:${VERSION}; docker push ${IMAGE}:latest
  on:
    branch: master
